<script>
  // Create a namespace object
  const PrisonMap = {
    esriConfig: {
      apiKey: "AAPTxy8BH1VEsoebNVZXo8HurBCyASoKLvJMp975P0MhDgOuTsrDo0KNXU1kRCxD8HVhcJ37PFTYJlUumgZryXmFp3p_BSw0Nd0qhhltCqh9FDqvJTkiq-rIVUJxV2ItFSBLxdAVItk41rtx3Ng_HOqYW6NSKSu7PgqQZvB1GgLU25h_5rt-GlnFTyMxisRRTvJM46bXmIANiymioQHcxrzrlmQg0uXsG5Nc5K25zKvbC60.AT1_HB22LyUE"
    },

    getRandomColor: function() {
      return new esri.Color([Math.random() * 255, Math.random() * 255, Math.random() * 255]);
    },

    createRenderer: function(field, uniqueValues) {
      return new esri.renderer.UniqueValueRenderer({
        field: field,
        uniqueValueInfos: uniqueValues.map(info => ({
          value: info.value,
          symbol: new esri.symbol.SimpleMarkerSymbol({
            color: info.color,
            size: 5,
            outline: null
          })
        })),
        defaultSymbol: new esri.symbol.SimpleMarkerSymbol({
          color: "gray",
          size: 5,
          outline: null
        })
      });
    },

    updateLegend: function(uniqueValueInfos) {
      const legendPanel = document.getElementById("legendPanel");
      legendPanel.innerHTML = ""; // Clear existing legend

      const legendList = document.createElement("calcite-list");
      legendList.layout = "inline";
      legendList.selectionMode = "none";

      uniqueValueInfos.forEach(info => {
        const listItem = document.createElement("calcite-list-item");

        // Create color box
        const colorBox = document.createElement("span");
        colorBox.style.display = "inline-block";
        colorBox.style.width = "16px";
        colorBox.style.height = "16px";
        colorBox.style.backgroundColor = info.color.toHex();
        colorBox.style.marginRight = "8px";
        colorBox.style.border = "1px solid black";

        // Append list item content
        listItem.innerHTML = `
          <div slot="content" style="display: flex; align-items: center;">
            ${colorBox.outerHTML}
            <span>${info.value}</span>
          </div>
        `;

        legendList.appendChild(listItem);
      });

      legendPanel.appendChild(legendList);
    },

    updateSymbology: function(field, corFacil) {
      let query = corFacil.createQuery();
      query.returnDistinctValues = true;
      query.returnGeometry = false;
      query.outFields = [field];

      corFacil.queryFeatures(query).then(result => {
        let values = result.features.map(f => f.attributes[field]);
        let uniqueValues = values.filter((value, index, self) => self.indexOf(value) === index);

        let uniqueValueInfos = uniqueValues.map(value => ({
          value: value,
          color: this.getRandomColor()
        }));

        corFacil.renderer = this.createRenderer(field, uniqueValueInfos);
        this.updateLegend(uniqueValueInfos);
      }).catch(error => console.error("Query failed:", error));
    },

    initializeMap: function(myarcgisMap) {
      myarcgisMap.addEventListener("arcgisViewReadyChange", (event) => {
        const myview = myarcgisMap.view;
        if (!myview) {
          console.error("View is not ready");
          return;
        }
        myview.navigation.actionMap.mouseWheel = 'none';

        document.addEventListener("wheel", (event) => {
          const targetLatitude = 31.0667;
          const targetLongitude = -92.0000;
          myview.goTo({
            center: [targetLongitude, targetLatitude],
            zoom: 7
          });
        });
      });
    },

    init: function() {
      // Get the ArcGIS map and view
      const myarcgisMap = document.querySelector("arcgis-map");

      // Correctional Facilities Layer
      const corFacil = new esri.layers.FeatureLayer({
        url: "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/Prison_Map/FeatureServer/0",
        popupTemplate: {
          title: "{NAME}",
          content: `
            <b>Type:</b> {Facil_Type}<br>
            <b>Age:</b> {Facil_Age}<br>
            <b>Scope:</b> {Facil_Scop}<br>
            <b>Gender:</b> {Facil_Gend}
          `
        },
        outFields: ["*"]
      });

      // Initialize map components and layers
      this.initializeMap(myarcgisMap);

      // Initialize symbology with default field
      this.updateSymbology("Facil_Type", corFacil);

      // Event listener for changing symbolization field
      document.getElementById("symbolFieldSelector").addEventListener("calciteSelectChange", (event) => {
        this.updateSymbology(event.target.value, corFacil);
      });

      // Add layers
      const baseURL = "https://services.arcgis.com/FvF9MZKp3JWPrSkg/arcgis/rest/services/Prison_Map/FeatureServer/";
      const baseLayers = [33, 34, 10]; 
      baseLayers.forEach(id => {
        myarcgisMap.addLayer(new esri.layers.FeatureLayer({
          url: `${baseURL}${id}`,
          outFields: ["*"]
        }));
      });

      myarcgisMap.addLayer(corFacil);
      myarcgisMap.basemap = null;
    }
  };

  // Initialize the map and application
  PrisonMap.init();

</script>
